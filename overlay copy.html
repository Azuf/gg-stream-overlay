<html>
    <head>
        <link rel="stylesheet" href="/lib/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="/style.css">
    </head>
    <body>
        <section id="settings" style="display: block;">
            <nav class="nav flex-column">
                <a class="nav-link active" aria-current="page" href="#">Active</a>
                <a class="nav-link" href="#">Link</a>
                <a class="nav-link" href="#">Link</a>
                <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
            </nav>
        </section>
        <section id="score-board">
            <svg
            xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 370.88 26.74">
            <defs>
                <style>.cls-1{fill:url(#linear-gradient);}.cls-2{font-size:13.44px;letter-spacing:0.02em;}.cls-11,.cls-2,.cls-5,.cls-7,.cls-8{fill:#fff;}.cls-11,.cls-2,.cls-5,.cls-8{font-family:EternalLogo-Regular, Eternal Logo;}.cls-3{fill:url(#linear-gradient-2);}.cls-4{fill:#1485bd;}.cls-5{font-size:8px;}.cls-6{letter-spacing:-0.07em;}.cls-8{font-size:12px;}.cls-9{fill:url(#linear-gradient-3);}.cls-10{fill:#ea7524;}.cls-11{font-size:9.16px;}</style>
                <linearGradient id="linear-gradient" x1="185.64" y1="26.74" x2="185.64" gradientUnits="userSpaceOnUse">
                    <stop offset="0" stop-color="#6b0c68"/>
                    <stop offset="1" stop-color="#4f1a72"/>
                </linearGradient>
                <linearGradient id="linear-gradient-2" x1="6.19" y1="6.59" x2="130.71" y2="6.59" gradientUnits="userSpaceOnUse">
                    <stop offset="0" stop-color="#92278f"/>
                    <stop offset="1" stop-color="#662d91"/>
                </linearGradient>
                <linearGradient id="linear-gradient-3" x1="160.57" y1="6.59" x2="285.09" y2="6.59" gradientTransform="matrix(-1, 0, 0, 1, 525.26, 0)" xlink:href="#linear-gradient-2"/>
            </defs>
            <title>Asset 1</title>
            <g id="Layer_2" data-name="Layer 2">
                <g id="Layer_1-2" data-name="Layer 1">
                        <g id="TIMER">
                            <polygon id="BACKGROUND" class="cls-1" points="219.63 26.74 225.51 0 145.78 0 151.66 26.74 219.63 26.74"/>
                            <text id="GAME_TIMER" class="cls-2" text-anchor="middle" transform="translate(185 17.28) scale(0.83 1)">00:00</text>
                        </g>
                        <g id="BLUE_TEAM">
                            <g id="TEAM_LABEL">
                                <polygon class="cls-3" points="9.09 13.18 130.71 13.18 127.81 0 6.19 0 9.09 13.18"/>
                                <polygon class="cls-4" points="2.9 13.18 9.09 13.18 6.19 0 0 0 2.9 13.18"/>
                                <text id="TEAM_NAME_ONE" class="cls-5" text-anchor="end" transform="translate(123 9.65)">TEAM BLOO</text>
                            </g>
                            <g id="LOGO">
                                <path class="cls-7" d="M11.94,6.2V2.39h.7V5.74h2.72V6.2Z"/>
                                <path class="cls-7" d="M16.14,4.29a2,2,0,0,1,.52-1.48,2,2,0,0,1,1.45-.53,1.92,1.92,0,0,1,1.44.54,2,2,0,0,1,.53,1.47,2,2,0,0,1-.53,1.48,1.92,1.92,0,0,1-1.44.54,1.94,1.94,0,0,1-1.45-.54A2,2,0,0,1,16.14,4.29Zm.74,0a1.76,1.76,0,0,0,.33,1.14,1.17,1.17,0,0,0,1.8,0,1.76,1.76,0,0,0,.33-1.14A1.8,1.8,0,0,0,19,3.15a1.19,1.19,0,0,0-1.8,0A1.8,1.8,0,0,0,16.88,4.29Z"/>
                                <path class="cls-7" d="M14.9,10.28a1.77,1.77,0,0,1-.63.46,2.19,2.19,0,0,1-.83.15A1.9,1.9,0,0,1,12,10.34a2,2,0,0,1-.55-1.46A2,2,0,0,1,12,7.41a2.14,2.14,0,0,1,1.54-.54,2.08,2.08,0,0,1,1.21.33,1.34,1.34,0,0,1,.56.92h-.76a.91.91,0,0,0-.34-.6,1.17,1.17,0,0,0-.71-.21,1.22,1.22,0,0,0-1,.4,1.74,1.74,0,0,0-.35,1.15A1.75,1.75,0,0,0,12.55,10a1.17,1.17,0,0,0,.94.41,1.13,1.13,0,0,0,.85-.33,1.18,1.18,0,0,0,.33-.87v0h-1.2V8.73h1.94v2.06H15Z"/>
                                <path class="cls-7" d="M16.14,8.88a2,2,0,0,1,.52-1.48,1.92,1.92,0,0,1,1.45-.53,2,2,0,0,1,1.44.53,2,2,0,0,1,.53,1.48,2,2,0,0,1-.53,1.48,1.91,1.91,0,0,1-1.44.53,1.93,1.93,0,0,1-1.45-.53A2,2,0,0,1,16.14,8.88Zm.74,0A1.8,1.8,0,0,0,17.21,10,1.19,1.19,0,0,0,19,10a1.8,1.8,0,0,0,.33-1.14A1.8,1.8,0,0,0,19,7.74a1.17,1.17,0,0,0-1.8,0A1.76,1.76,0,0,0,16.88,8.88Z"/>
                            </g>
                            <g id="SCORE">
                                <polygon id="SCORE_BACKGROUND" class="cls-4" points="154.21 21.61 132.61 21.61 127.81 0 149.42 0 154.21 21.61"/>
                                <text id="SCORE_ONE" data-name="TEXT" class="cls-5" text-anchor="middle" transform="translate(141 14)">0</text>
                            </g>
                            <g id="BEST_OF_X_ONE">
                                <g id="SCORE-2" data-name="SCORE">
                                    <polygon id="SCORE_BACKGROUND-2" data-name="SCORE_BACKGROUND" class="cls-4 GAME_WIN-1" points="130.16 18.27 108.56 18.27 107.94 14.69 129.55 14.69 130.16 18.27"/>
                                </g>
                                <g id="SCORE-6" data-name="SCORE">
                                    <polygon id="SCORE_BACKGROUND-3" data-name="SCORE_BACKGROUND" class="cls-4 GAME_WIN-2" points="107.23 18.27 85.62 18.27 85.01 14.69 106.61 14.69 107.23 18.27"/>
                                </g>
                                <g id="SCORE-3" data-name="SCORE">
                                    <polygon id="SCORE_BACKGROUND-4" data-name="SCORE_BACKGROUND" class="cls-4 GAME_WIN-3" points="84 18.27 62.39 18.27 61.78 14.69 83.39 14.69 84 18.27"/>
                                </g>
                                <g id="SCORE-4" data-name="SCORE">
                                    <polygon id="SCORE_BACKGROUND-5" data-name="SCORE_BACKGROUND" class="cls-4 GAME_WIN-4" points="60.68 18.27 39.07 18.27 38.46 14.69 60.06 14.69 60.68 18.27"/>
                                </g>
                                <g id="SCORE-5" data-name="SCORE">
                                    <polygon id="SCORE_BACKGROUND-6" data-name="SCORE_BACKGROUND" class="cls-4 GAME_WIN-5" points="37.57 18.27 15.97 18.27 15.36 14.69 36.96 14.69 37.57 18.27"/>
                                </g>
                            </g>
                        </g>
                        <g id="ORANGE_TEAM">
                            <g id="TEAM_LABEL-2" data-name="TEAM_LABEL">
                                <polygon class="cls-9" points="361.79 13.18 240.17 13.18 243.07 0 364.69 0 361.79 13.18"/>
                                <polygon class="cls-10" points="367.99 13.18 361.79 13.18 364.69 0 370.88 0 367.99 13.18"/>
                                <text id="TEAM_NAME_TWO" data-name="TEAM_NAME" class="cls-5" transform="translate(247 9.65)">TEAM</text>
                            </g>
                            <g id="LOGO-2" data-name="LOGO">
                                <path class="cls-7" d="M350.22,6.2V2.39h.71V5.74h2.71V6.2Z"/>
                                <path class="cls-7" d="M354.42,4.29A2,2,0,0,1,355,2.81a2,2,0,0,1,1.44-.53,1.92,1.92,0,0,1,1.45.54,2,2,0,0,1,.53,1.47,2,2,0,0,1-.53,1.48,2.2,2.2,0,0,1-2.89,0A2,2,0,0,1,354.42,4.29Zm.74,0a1.76,1.76,0,0,0,.33,1.14,1.08,1.08,0,0,0,.9.42,1.1,1.1,0,0,0,.91-.42,1.76,1.76,0,0,0,.33-1.14,1.8,1.8,0,0,0-.33-1.14,1.12,1.12,0,0,0-.91-.41,1.1,1.1,0,0,0-.9.41A1.8,1.8,0,0,0,355.16,4.29Z"/>
                                <path class="cls-7" d="M353.18,10.28a1.61,1.61,0,0,1-.63.46,2.14,2.14,0,0,1-.82.15,1.92,1.92,0,0,1-1.43-.55,2,2,0,0,1-.55-1.46,1.93,1.93,0,0,1,.57-1.47,2.13,2.13,0,0,1,1.54-.54,2,2,0,0,1,1.2.33,1.38,1.38,0,0,1,.57.92h-.76a.92.92,0,0,0-.35-.6,1.13,1.13,0,0,0-.71-.21,1.23,1.23,0,0,0-1,.4,1.73,1.73,0,0,0-.34,1.15,1.75,1.75,0,0,0,.34,1.15,1.2,1.2,0,0,0,.94.41,1.15,1.15,0,0,0,.86-.33,1.18,1.18,0,0,0,.33-.87v0h-1.2V8.73h1.94v2.06h-.39Z"/>
                                <path class="cls-7" d="M354.42,8.88A2,2,0,0,1,355,7.4a1.91,1.91,0,0,1,1.44-.53,2,2,0,0,1,1.45.53,2,2,0,0,1,.53,1.48,2,2,0,0,1-.53,1.48,2.23,2.23,0,0,1-2.89,0A2,2,0,0,1,354.42,8.88Zm.74,0a1.8,1.8,0,0,0,.33,1.14,1.1,1.1,0,0,0,.9.41,1.12,1.12,0,0,0,.91-.41,1.8,1.8,0,0,0,.33-1.14,1.8,1.8,0,0,0-.33-1.14,1.1,1.1,0,0,0-.91-.42,1.08,1.08,0,0,0-.9.42A1.76,1.76,0,0,0,355.16,8.88Z"/>
                            </g>
                            <g id="SCORE-7" data-name="SCORE">
                                <polygon id="SCORE_BACKGROUND-7" data-name="SCORE_BACKGROUND" class="cls-10" points="216.67 21.61 238.28 21.61 243.07 0 221.46 0 216.67 21.61"/>
                                <text id="SCORE_TWO" data-name="TEXT" class="cls-5" text-anchor="middle" transform="translate(229 14)">0</text>
                            </g>
                            <g id="BEST_OF_X_TWO" data-name="BEST_OF_X">
                                <g id="SCORE-8" data-name="SCORE">
                                    <polygon id="SCORE_BACKGROUND-8" data-name="SCORE_BACKGROUND" class="cls-10 GAME_WIN-1" points="240.64 18.27 262.25 18.27 262.86 14.69 241.25 14.69 240.64 18.27"/>
                                </g>
                                <g id="SCORE-12" data-name="SCORE">
                                    <polygon id="SCORE_BACKGROUND-9" data-name="SCORE_BACKGROUND" class="cls-10 GAME_WIN-2" points="263.58 18.27 285.18 18.27 285.79 14.69 264.19 14.69 263.58 18.27"/>
                                </g>
                                <g id="SCORE-9" data-name="SCORE">
                                    <polygon id="SCORE_BACKGROUND-10" data-name="SCORE_BACKGROUND" class="cls-10 GAME_WIN-3" points="286.8 18.27 308.41 18.27 309.02 14.69 287.42 14.69 286.8 18.27"/>
                                </g>
                                <g id="SCORE-10" data-name="SCORE">
                                    <polygon id="SCORE_BACKGROUND-11" data-name="SCORE_BACKGROUND" class="cls-10 GAME_WIN-4" points="310.12 18.27 331.73 18.27 332.34 14.69 310.74 14.69 310.12 18.27"/>
                                </g>
                                <g id="SCORE-11" data-name="SCORE">
                                    <polygon id="SCORE_BACKGROUND-12" data-name="SCORE_BACKGROUND" class="cls-10 GAME_WIN-5" points="333.23 18.27 354.83 18.27 355.45 14.69 333.84 14.69 333.23 18.27"/>
                                </g>
                            </g>
                        </g>
                    </g>
                </g>
            </svg>
        </section>
        <section id="active-player-info">
            <div class="name">Squishy</div>
            <div class="stats">
                <div class="stat score">
                    <div class="title">score</div>
                    <div class="value">0</div>
                </div>     
                <div class="stat goals">
                    <div class="title">goals</div>
                    <div class="value">0</div>
                </div>     
                <div class="stat shots">
                    <div class="title">shots</div>
                    <div class="value">0</div>
                </div>     
                <div class="stat assists">
                    <div class="title">assists</div>
                    <div class="value">0</div>
                </div>
                <div class="stat saves">
                    <div class="title">saves</div>
                    <div class="value">0</div>
                </div>    
            </div>     
            <div class="boost"><div class="bar"><div class="color"></div></div></div> 
        </section>
        <section id="replay_overlay">
            <video muted>
                <source src="/vidoes/Replay.webm">
                Your browser does not support the video tag.
            </video>
            <div id="replay-label">REPLAY</div>
        </section>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
        <script src="/relay_subsriber.js"></script>
        <script src="/lib/j-linq.js"></script>
        <script>
            // game:initialized                 
            //// Times ////
            // game:round_started_go            // round began    
            // game:pre_countdown_begin         // 3. 2. 1.. on game start or after every goal 
            // game:post_countdown_begin        
            // game:match_ended
            // game:podium_start
            
            //// Time tracking ////
            // game:clock_stopped               
            // game:clock_started               
            // game:clock_updated_seconds
            
            //// Events ////
            // game:ball_hit
            // game:goal_scored
            // game:replay_start
            // game:replay_end
            // game:clock_stopped
            // game:statfeed_event
            // game:update_state
            // game:match_destroyed

            // colors
            let TeamOneColor = '#0091D3';
            let TeamTwoColor = '#F6632A';
            
            //// ELEMENTS START ////
            // tournamet stats
            let team_one_games_won = 1;
            let team_two_games_won = 3;

            // matches won
            for(let i = 5; i > 0; i--) {
                if(team_one_games_won < i) {
                    $(`#BEST_OF_X_ONE [class*=GAME_WIN-${i}]`).hide();
                }    
                if(team_two_games_won < i) {
                    $(`#BEST_OF_X_TWO [class*=GAME_WIN-${i}]`).hide();
                }    
            }

            let score_board = $('#score-board');
            let replay_label = $('#replay-label');

            let score_one = $('#SCORE_ONE');
            let score_two = $('#SCORE_TWO');

            let team_one_name = $('#TEAM_NAME_ONE');
            let team_two_name = $('#TEAM_NAME_TWO');
            let isTeamNamesSet = false;

            let game_timer = $('#GAME_TIMER');
            
            let active_player_elem = $('#active-player-info'); 
            let active_name_val = $('#active-player-info .name');
            let active_score_val = $('#active-player-info .score .value');
            let active_goals_val = $('#active-player-info .goals .value');
            let active_shots_val = $('#active-player-info .shots .value');
            let active_assists_val = $('#active-player-info .assists .value');
            let active_saves_val = $('#active-player-info .saves .value');
            let active_boost_bar = $('#active-player-info .boost .bar');

            let replay_overlay = document.querySelector('#replay_overlay video');
            // replay_overlay.load();
            // replay_overlay.play();
            //// ELEMENTS END ////
            
            let ActivePlayer = {};
            
            // TEST CODE ??//
                active_player_elem.css('background-color', TeamOneColor);
                active_name_val.css('background-color', TeamOneColor);
            // TEST CODE ??//
            

            $(() => {
                // connect
                WsSubscribers.init(49322, true);

                // main game stats
                WsSubscribers.subscribe("game", "update_state", (e) => {
                    // console.log(e);
                    game_timer.text(getTime(e.game));
                    if(e.game.isReplay) replay_label.show(); else replay_label.hide();
                    
                    // set team names : ONLY ONCE
                    if(!isTeamNamesSet) {
                        team_one_name.text(e.game.teams[0].name);
                        team_two_name.text(e.game.teams[1].name);
                        isTeamNamesSet = true;
                    }

                    let active_target = e.game.target;

                    if(active_target.length > 0) { // display active target data if this is present...
                        ActivePlayer = e.players[e.game.target];
                        DisplayActivePlayerInfo();
                    } else { // ...otherwise hide it
                        active_player_elem.hide();
                    }
                    // console.log(e.game.target);

                    /* incase we need shrink down the text size*/
                    // if(e.game.teams[0].score > 9)
                    //     score_one.attr('style', 'font-size: 12px');
                    
                    // if(e.game.teams[1].score > 9)
                    //     score_two.attr('style', 'font-size: 12px');

                    score_one.text(e.game.teams[0].score);
                    score_two.text(e.game.teams[1].score);
                });
                
                WsSubscribers.subscribe("game", "goal_scored", (e) => {
                    replayStart(1550);
                });
                WsSubscribers.subscribe("game", "replay_end", (e) => {
                    replayEnd(0);
                });
                
                let unique_stats = [];

                WsSubscribers.subscribe("game", "statfeed_event", (e) => {
                    if(unique_stats.any(x => x == e.type)) return;

                    unique_stats.push(e.type);
                    console.log(e.type); 
                });

                function replayStart(milis) {
                    setTimeout(() => {
                        replay_overlay.play();
                    }, milis);

                    // setTimeout(() => { // issue when replay is skipped
                    //     score_board.hide();
                    // }, milis + 500);
                }

                function replayEnd(milis) {
                    setTimeout(() => {
                        replay_overlay.play();
                    }, milis);
                    
                    setTimeout(() => {
                        score_board.show();
                    }, milis + 500);
                }
            });
            
            function DisplayActivePlayerInfo() {
                if($.isEmptyObject(ActivePlayer)) return; // just in case
                
                // get the team color from the player
                let team_color = ActivePlayer.team == 0 ? TeamOneColor : TeamTwoColor;
                active_player_elem.css('background-color', team_color);
                active_name_val.css('background-color', team_color);

                // show the elem if its hidden
                active_player_elem.show();
                
                active_name_val.text(ActivePlayer.name);
                active_goals_val.text(ActivePlayer.goals);
                active_shots_val.text(ActivePlayer.shots);
                active_score_val.text(ActivePlayer.score);
                active_assists_val.text(ActivePlayer.assists);
                active_saves_val.text(ActivePlayer.saves);
                active_boost_bar.css('width', `${ActivePlayer.boost}%`); 
                // active_boost_bar.css('filter', `hue-rotate(${275*(1 - (ActivePlayer.boost/100))}deg)`); 
                // active_boost_bar.text(`${ActivePlayer.speed}mph`); 
            }
            
            // function str_pad_left(string){
            //     let pad = '0';
            //     let length = 2;   
            //     return (new Array(length+1).join(pad)+string).slice(-length);   
            // }

            // function getTime(game) {
            //     var minutes = str_pad_left((Math.floor(game.time / 100)));
            //     // var seconds = str_pad_left((Math.round(game.time - minutes * 60)));
            //     var seconds = 0;
            //     return `${game.isOT ? '+' : ''}${minutes}:${seconds}`;
            // }

            // function getTime(game) {
            //     let time = (game.isOT ? '+' : '') 
            //     let showMs = game.time < 60 && !game.isOT;
            //     return time + (new Date(Math.ceil(game.time) * 1000)).toISOString().substr(showMs ? 17 : 15, 4);
            // }

            function getTime(game) {
                var m = Math.floor(game.time / 60);
                var s = ((Math.trunc(Math.ceil(game.time)) % 60)).toFixed(0);

                return `${(game.isOT ? '+' : "")} ${m}:${s < 10 ? '0' : ''}${s}`;
            }

            
                

       </script>
    </body>
</html>