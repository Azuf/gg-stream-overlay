<html>
    <head>
        <link rel="stylesheet" href="/lib/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="/style.css">
    </head>
    <body>
        <!-- <section id="settings" style="display: block;">
            <nav class="nav flex-column">
                <a class="nav-link active" aria-current="page" href="#">Active</a>
                <a class="nav-link" href="#">Link</a>
                <a class="nav-link" href="#">Link</a>
                <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
            </nav>
        </section> -->
        <section id="score-board">
            <svg id="Layer_1" data-name="Layer 1"
            xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 334.78 21.38">
            <defs>
                <style>.cls-1{fill:url(#linear-gradient);}.cls-2{font-size:14.87px;letter-spacing:0.02em;}.cls-2,.cls-5,.cls-9{fill:#fff;font-family:EternalLogo-Regular, Eternal Logo;}.cls-3{fill:#1485bd;}.cls-4{fill:url(#linear-gradient-2);}.cls-5{font-size:5.16px;letter-spacing:-0.05em;}.cls-6{letter-spacing:0em;}.cls-7{letter-spacing:-0.26em;}.cls-8{fill:#2a1043;}.cls-9{font-size:9.57px;}.cls-10{fill:#f15a29;}.cls-11{fill:url(#linear-gradient-3);}</style>
                <linearGradient id="linear-gradient" x1="167.44" y1="21.34" x2="167.44" gradientUnits="userSpaceOnUse">
                    <stop offset="0" stop-color="#5d005a"/>
                    <stop offset="1" stop-color="#400a5e"/>
                </linearGradient>
                <linearGradient id="linear-gradient-2" x1="19.47" y1="8.35" x2="120.21" y2="8.35" gradientUnits="userSpaceOnUse">
                    <stop offset="0" stop-color="#92278f"/>
                    <stop offset="1" stop-color="#662d91"/>
                </linearGradient>
                <linearGradient id="linear-gradient-3" x1="5.61" y1="8.43" x2="106.35" y2="8.43" gradientTransform="matrix(-1, 0, 0, 1, 320.92, -0.08)" xlink:href="#linear-gradient-2"/>
            </defs>
            <title>scoreboard</title>
            <polygon class="cls-1" points="218.28 0 167.39 0 167.39 0 116.59 0 121.28 21.34 194.95 21.34 194.95 21.34 213.59 21.34 218.28 0"/>
            <text id="GAME_TIMER" class="cls-2" text-anchor="middle" transform="translate(167.5 15.13) scale(0.62 1)">23:56</text>
            <g id="BLUE_TEAM">
                <polygon id="BLUE_TEAM_THINGY" class="cls-3" points="3.71 16.69 8.66 16.69 4.94 0 0 0 3.71 16.69"/>
                <g id="BLUE_TEAM_BANNER">
                    <polygon id="BLUE_TEAM_BANNER_BAKCGROUND" class="cls-4" points="23.17 16.69 120.2 16.69 116.5 0 19.47 0 23.17 16.69"/>
                    <text id="BLUE_TEAM_NAME" class="cls-5" text-anchor="end" style="letter-spacing:.015rem" transform="translate(112 9.9)">TC CHIPS FRATERNITY</text>
                </g>
                <g id="BLUE_BEST_OF_X">
                    <g id="BLUE_WINS-5">
                        <path id="SCORE_BACKGROUND" class="cls-3" d="M177.43,20.33h-9.76a.33.33,0,0,1-.33-.28L167.15,19a.34.34,0,0,1,.33-.39h9.76a.32.32,0,0,1,.33.27l.19,1.07A.34.34,0,0,1,177.43,20.33Z" transform="translate(-109.14 -0.08)"/>
                    </g>
                    <g id="BLUE_WINS-4">
                        <path id="SCORE_BACKGROUND-2" data-name="SCORE_BACKGROUND" class="cls-3" d="M189.63,20.33h-9.77a.32.32,0,0,1-.32-.28L179.35,19a.33.33,0,0,1,.33-.38h9.77a.31.31,0,0,1,.32.27l.19,1.07A.34.34,0,0,1,189.63,20.33Z" transform="translate(-109.14 -0.08)"/>
                    </g>
                    <g id="BLUE_WINS-3">
                        <path id="SCORE_BACKGROUND-3" data-name="SCORE_BACKGROUND" class="cls-3" d="M201.83,20.33h-9.77a.32.32,0,0,1-.32-.28L191.55,19a.33.33,0,0,1,.33-.38h9.77a.31.31,0,0,1,.32.27l.19,1.07A.34.34,0,0,1,201.83,20.33Z" transform="translate(-109.14 -0.08)"/>
                    </g>
                    <g id="BLUE_WINS-2">
                        <path id="SCORE_BACKGROUND-4" data-name="SCORE_BACKGROUND" class="cls-3" d="M214,20.33h-9.77a.33.33,0,0,1-.32-.28L203.75,19a.33.33,0,0,1,.33-.38h9.77a.31.31,0,0,1,.32.27l.19,1.07A.34.34,0,0,1,214,20.33Z" transform="translate(-109.14 -0.08)"/>
                    </g>
                    <g id="BLUE_WINS-1">
                        <path id="SCORE_BACKGROUND-5" data-name="SCORE_BACKGROUND" class="cls-3" d="M226.23,20.33h-9.77a.33.33,0,0,1-.32-.28L216,19a.32.32,0,0,1,.32-.38h9.77a.31.31,0,0,1,.32.27l.19,1.07A.34.34,0,0,1,226.23,20.33Z" transform="translate(-109.14 -0.08)"/>
                    </g>
                </g>
                <g id="BLUE_LOGO">
                    <path id="BLUE_LOGO_BACKGROUND" class="cls-8" d="M117.8,16.77H140a.55.55,0,0,0,.54-.67L137,.09H114.09Z" transform="translate(-109.14 -0.08)"/>
                    <image alignment-baseline="middle" id="BLUE_LOGO_IMAGE" transform="translate(12.5 2)" width="12" height="12" href="/Teams/Clockwise/Clockwise LOGO.png"/>
                </g>
                <g id="BLUE_SCORE_BOARD">
                    <polygon id="SCORE_BACKGROUND-6" data-name="SCORE_BACKGROUND" class="cls-3" points="143.9 21.38 119.58 21.38 116.49 7.7 140.81 7.7 143.9 21.38"/>
                    <text id="BLUE_SCORE" class="cls-9" text-anchor="middle" transform="translate(130 17.65)">0</text>
                </g>
            </g>
            <g id="ORANGE_TEAM">
                <polygon id="ORANGE_TEAM_THINGY" class="cls-10" points="331.06 16.69 326.12 16.69 329.84 0 334.78 0 331.06 16.69"/>
                <g id="ORANGE_TEAM_BANNER">
                    <polygon id="ORANGE_TEAM_BANNER_BAKCGROUND" class="cls-11" points="311.61 16.69 214.57 16.69 218.28 0 315.31 0 311.61 16.69"/>
                    <text id="ORANGE_TEAM_NAME" class="cls-5" text-anchor="start" style="letter-spacing:.015rem" transform="translate(222 9.9)">TC CHIPS FRATERNITY</text>
                </g>
                <g id="ORANGE_BEST_OF_X">
                    <g id="ORANGE_WINS-5">
                        <path id="SCORE_BACKGROUND-7" data-name="SCORE_BACKGROUND" class="cls-10" d="M376.57,20.33h9.76a.34.34,0,0,0,.33-.28l.18-1.06a.33.33,0,0,0-.33-.39h-9.76a.33.33,0,0,0-.33.27l-.18,1.07A.33.33,0,0,0,376.57,20.33Z" transform="translate(-109.14 -0.08)"/>
                    </g>
                    <g id="ORANGE_WINS-4">
                        <path id="SCORE_BACKGROUND-8" data-name="SCORE_BACKGROUND" class="cls-10" d="M364.36,20.33h9.77a.34.34,0,0,0,.33-.28l.18-1.07a.33.33,0,0,0-.32-.38h-9.77a.33.33,0,0,0-.33.27L364,19.94A.33.33,0,0,0,364.36,20.33Z" transform="translate(-109.14 -0.08)"/>
                    </g>
                    <g id="ORANGE_WINS-3">
                        <path id="SCORE_BACKGROUND-9" data-name="SCORE_BACKGROUND" class="cls-10" d="M352.16,20.33h9.77a.34.34,0,0,0,.33-.28l.18-1.07a.33.33,0,0,0-.32-.38h-9.78a.32.32,0,0,0-.32.27l-.18,1.07A.33.33,0,0,0,352.16,20.33Z" transform="translate(-109.14 -0.08)"/>
                    </g>
                    <g id="ORANGE_WINS-2">
                        <path id="SCORE_BACKGROUND-10" data-name="SCORE_BACKGROUND" class="cls-10" d="M340,20.33h9.77a.34.34,0,0,0,.33-.28l.18-1.07a.33.33,0,0,0-.33-.38h-9.77a.32.32,0,0,0-.32.27l-.18,1.07A.33.33,0,0,0,340,20.33Z" transform="translate(-109.14 -0.08)"/>
                    </g>
                    <g id="ORANGE_WINS-1">
                        <path id="SCORE_BACKGROUND-11" data-name="SCORE_BACKGROUND" class="cls-10" d="M327.76,20.33h9.77a.32.32,0,0,0,.32-.28L338,19a.33.33,0,0,0-.33-.38h-9.77a.32.32,0,0,0-.32.27l-.18,1.07A.33.33,0,0,0,327.76,20.33Z" transform="translate(-109.14 -0.08)"/>
                    </g>
                </g>
                <g id="ORANGE_LOGO">
                    <path id="ORANGE_LOGO_BACKGROUND" class="cls-8" d="M435.27,16.77H413a.55.55,0,0,1-.54-.67L416,.09H439Z" transform="translate(-109.14 -0.08)"/>
                    <image alignment-baseline="middle" id="ORANGE_LOGO_IMAGE" transform="translate(310 2)" width="12" height="12" href="/Teams/Clockwise/Clockwise LOGO.png"/>
                </g>
                <g id="ORANGE_SCORE_BOARD">
                    <polygon id="ORANGE_SCORE_BACKGROUND" class="cls-10" points="190.88 21.38 215.2 21.38 218.29 7.7 193.97 7.7 190.88 21.38"/>
                    <text id="ORANGE_SCORE" class="cls-9" text-anchor="middle" transform="translate(204.5 17.65)">0</text>
                </g>
            </g>
            </svg>
        </section>
        <section id="blue-team-stats">
            <div class="player" data-id='1'>
                <div class="name"></div>
                <div class="stats">
                    <span class="goals">
                        <img src="/img/Goal_points_icon.png">
                        <span class="value"></span>
                    </span>
                    <span class="ontarget">
                        <img src="/img/Shot_on_Goal_points_icon.png">
                        <span class="value"></span>
                    </span>
                    <span class="assists">
                        <img src="/img/Assist_points_icon.png">
                        <span class="value"></span>
                    </span>
                    <span class="saves">
                        <img src="/img/Save_points_icon.png">
                        <span class="value"></span>
                    </span>
                </div>
                <div class="boost"><div class="bar"></div></div>
            </div>
            <div class="player" data-id='2'>
                <div class="name"></div>
                <div class="stats">
                    <span class="goals">
                        <img src="/img/Goal_points_icon.png">
                        <span class="value"></span>
                    </span>
                    <span class="ontarget">
                        <img src="/img/Shot_on_Goal_points_icon.png">
                        <span class="value"></span>
                    </span>
                    <span class="assists">
                        <img src="/img/Assist_points_icon.png">
                        <span class="value"></span>
                    </span>
                    <span class="saves">
                        <img src="/img/Save_points_icon.png">
                        <span class="value"></span>
                    </span>
                </div>
                <div class="boost"><div class="bar"></div></div>
            </div>
            <div class="player" data-id='3'>
                <div class="name"></div>
                <div class="stats">
                    <span class="goals">
                        <img src="/img/Goal_points_icon.png">
                        <span class="value"></span>
                    </span>
                    <span class="ontarget">
                        <img src="/img/Shot_on_Goal_points_icon.png">
                        <span class="value"></span>
                    </span>
                    <span class="assists">
                        <img src="/img/Assist_points_icon.png">
                        <span class="value"></span>
                    </span>
                    <span class="saves">
                        <img src="/img/Save_points_icon.png">
                        <span class="value"></span>
                    </span>
                </div>
                <div class="boost"><div class="bar"></div></div>
            </div>
        </section>
        <section id="orange-team-stats">
            <div class="player" data-id='1'>
                <div class="name"></div>
                <div class="stats">
                    <span class="goals">
                        <img src="/img/Goal_points_icon.png">
                        <span class="value"></span>
                    </span>
                    <span class="ontarget">
                        <img src="/img/Shot_on_Goal_points_icon.png">
                        <span class="value"></span>
                    </span>
                    <span class="assists">
                        <img src="/img/Assist_points_icon.png">
                        <span class="value"></span>
                    </span>
                    <span class="saves">
                        <img src="/img/Save_points_icon.png">
                        <span class="value"></span>
                    </span>
                </div>
                <div class="boost"><div class="bar"></div></div>
            </div>
            <div class="player" data-id='2'>
                <div class="name"></div>
                <div class="stats">
                    <span class="goals">
                        <img src="/img/Goal_points_icon.png">
                        <span class="value"></span>
                    </span>
                    <span class="ontarget">
                        <img src="/img/Shot_on_Goal_points_icon.png">
                        <span class="value"></span>
                    </span>
                    <span class="assists">
                        <img src="/img/Assist_points_icon.png">
                        <span class="value"></span>
                    </span>
                    <span class="saves">
                        <img src="/img/Save_points_icon.png">
                        <span class="value"></span>
                    </span>
                </div>
                <div class="boost"><div class="bar"></div></div>
            </div>
            <div class="player" data-id='3'>
                <div class="name"></div>
                <div class="stats">
                    <span class="goals">
                        <img src="/img/Goal_points_icon.png">
                        <span class="value"></span>
                    </span>
                    <span class="ontarget">
                        <img src="/img/Shot_on_Goal_points_icon.png">
                        <span class="value"></span>
                    </span>
                    <span class="assists">
                        <img src="/img/Assist_points_icon.png">
                        <span class="value"></span>
                    </span>
                    <span class="saves">
                        <img src="/img/Save_points_icon.png">
                        <span class="value"></span>
                    </span>
                </div>
                <div class="boost"><div class="bar"></div></div>
            </div>
        </section>

        <section id="replay_overlay">
            <video muted>
                <source src="/vidoes/Replay.webm">
                Your browser does not support the video tag.
            </video>
            <div id="replay-label">REPLAY</div>
        </section>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
        <script src="/lib/bootstrap/js/bootstrap.min.js"></script>
        <script src="/relay_subsriber.js"></script>
        <script src="/lib/j-linq.js"></script>
        <script>
            // game:initialized                 
            //// Times ////
            // game:round_started_go            // round began    
            // game:pre_countdown_begin         // 3. 2. 1.. on game start or after every goal 
            // game:post_countdown_begin        
            // game:match_ended
            // game:podium_start
            
            //// Time tracking ////
            // game:clock_stopped               
            // game:clock_started               
            // game:clock_updated_seconds
            
            //// Events ////
            // game:ball_hit
            // game:goal_scored
            // game:replay_start
            // game:replay_end
            // game:clock_stopped
            // game:statfeed_event
            // game:update_state
            // game:match_destroyed
            let MATCH_STARTED = true;

            $('#BLUE_LOGO_IMAGE').attr('href', 'none');

            // colors
            let TeamOneColor = '#0091D3';
            let TeamTwoColor = '#F6632A';
            
            //// ELEMENTS START ////
            // tournamet stats
            let team_one_games_won = 0;
            let team_two_games_won = 0;

            // matches won
            for(let i = 5; i > 0; i--) {
                if(team_one_games_won < i) {
                    $(`#BLUE_WINS-${i}`).hide();
                }    
                if(team_two_games_won < i) {
                    $(`#ORANGE_WINS-${i}`).hide();
                }    
            }

            let score_board = $('#score-board');
            let replay_label = $('#replay-label');

            let score_one = $('#BLUE_SCORE');
            let score_two = $('#ORANGE_SCORE');

            let team_one_name = $('#BLUE_TEAM_NAME');
            let team_two_name = $('#ORANGE_TEAM_NAME');
            let isTeamNamesSet = false;

            let game_timer = $('#GAME_TIMER');

            const player = '-team-stats .player[data-id="%id%"]';
            let teams = {};
            
            // let active_player_elem = $('#active-player-info'); 
            // let active_name_val = $('#active-player-info .name');
            // let active_score_val = $('#active-player-info .score .value');
            // let active_goals_val = $('#active-player-info .goals .value');
            // let active_shots_val = $('#active-player-info .shots .value');
            // let active_assists_val = $('#active-player-info .assists .value');
            // let active_saves_val = $('#active-player-info .saves .value');
            // let active_boost_bar = $('#active-player-info .boost .bar');

            let replay_overlay = document.querySelector('#replay_overlay video');
            // replay_overlay.load();
            // replay_overlay.play();
            //// ELEMENTS END ////
            
            let ActivePlayer = '';
            
            // TEST CODE ??//
                // active_player_elem.css('background-color', TeamOneColor);
                // active_name_val.css('background-color', TeamOneColor);
            // TEST CODE ??//
            

            $(() => {
                // connect
                WsSubscribers.init(49322, true);

                // main game stats
                WsSubscribers.subscribe("game", "update_state", (e) => {
                    // console.log(e);
                    game_timer.text(getTime(e.game));
                    if(e.game.isReplay) replay_label.show(); else replay_label.hide();
                    
                    // set team names : ONLY ONCE
                    if(!isTeamNamesSet) {
                        team_one_name.text(e.game.teams[0].name);
                        team_two_name.text(e.game.teams[1].name);
                        isTeamNamesSet = true;
                    }
                    
                    ActivePlayer = e.game.target;

                    DisplayPlayerInfo(e);

                    score_one.text(e.game.teams[0].score);
                    score_two.text(e.game.teams[1].score);
                });
                
                WsSubscribers.subscribe("game", "goal_scored", (e) => {
                    replayStart(1550);
                });
                WsSubscribers.subscribe("game", "replay_end", (e) => {
                    replayEnd(0);
                });
                
                let unique_stats = [];

                WsSubscribers.subscribe("game", "statfeed_event", (e) => {
                    if(unique_stats.any(x => x == e.type)) return;

                    unique_stats.push(e.type);
                    console.log(e.type); 
                });

                WsSubscribers.subscribe("game", "match_created", (e) => {
                    MATCH_STARTED = true;
                });

                WsSubscribers.subscribe("game", "game:match_ended", (e) => {
                    MATCH_STARTED = false;
                });
                
                function replayStart(milis) {
                    setTimeout(() => {
                        replay_overlay.play();
                    }, milis);

                    // setTimeout(() => { // issue when replay is skipped
                    //     score_board.hide();
                    // }, milis + 500);
                }

                function replayEnd(milis) {
                    setTimeout(() => {
                        replay_overlay.play();
                    }, milis);
                    
                    setTimeout(() => {
                        score_board.show();
                    }, milis + 500);
                }
            });

            function DisplayPlayerInfo(e) {
                if($.isEmptyObject(teams)) {
                    let ps = e.players;
                    teams = {
                        blue: [],
                        orange: []
                    };
                    
                    let blue_count = 0;
                    let orange_count = 0;

                    for(const p of Object.entries(ps)) {
                        let val = p[1];
                        console.log(val);
                        if(val.team == 0) {
                            let elem = $(`#blue${player.replace('%id%', ++blue_count)}`);
                            elem.attr('data-player-id', val.id);

                            let name = elem.find('.name');
                            if (name) name.text(val.name);
                            
                            let boost = elem.find('.bar');
                            if(boost) boost.css('background', TeamOneColor);

                            teams.blue.push({
                                player_id: val.id,
                                jElem: elem
                            });
                        } else {
                            let elem = $(`#orange${player.replace('%id%', ++orange_count)}`);
                            elem.attr('data-player-id', val.id);

                            let name = elem.find('.name');
                            if (name) name.text(val.name);

                            let boost = elem.find('.bar');
                            if(boost) boost.css('background', TeamTwoColor);
                            
                            teams.orange.push({
                                player_id: val.id,
                                jElem: elem
                            });
                        }
                    }
                }

                if(!MATCH_STARTED) return;

                ['blue', 'orange'].forEach((t) => {
                    let team = teams[t];
                    for(let i = 0; i < 3; i++) {
                        // console.log(team);
                        let p = team[i];

                        if(!p || !p.jElem) {
                            teams = {};
                            return;
                        };

                        let id = p.jElem.data('player-id');
                        if(!e.players[p.player_id]) {
                            teams = {};
                            return;
                        };

                        
                        let boost = p.jElem.find('.bar');
                        if(boost) boost.css('width', `${e.players[p.player_id].boost}%`);
                        
                        let k = p.jElem.find('.stats');
                        if(id != ActivePlayer) {
                            k.addClass('hide');
                            continue;
                        } else {k.removeClass('hide');} 
                        // if(p.jElem.data('player-id') != ActivePlayer) return; 
                        // if(ActivePlayer) console.log(ActivePlayer);
                        // console.log(p.jElem.data('player-id'));

                        let goals = p.jElem.find('.goals .value');
                        if(goals) goals.text(e.players[p.player_id].goals);

                        let ontarget = p.jElem.find('.ontarget .value');
                        if(ontarget) {
                            ontarget.text(e.players[p.player_id].shots);
                        }
                        
                        let assists = p.jElem.find('.assists .value');
                        if(assists) assists.text(e.players[p.player_id].assists);

                        let saves = p.jElem.find('.saves .value');
                        if(saves) saves.text(e.players[p.player_id].saves);
                        // console.log(p.jElem);
                    }
                });
            }
            
            function DisplayActivePlayerInfo() {
                if($.isEmptyObject(ActivePlayer)) return; // just in case
                
                // get the team color from the player
                let team_color = ActivePlayer.team == 0 ? TeamOneColor : TeamTwoColor;
                // active_player_elem.css('background-color', team_color);
                // active_name_val.css('background-color', team_color);

                // show the elem if its hidden
                // active_player_elem.show();
                
                active_name_val.text(ActivePlayer.name);
                active_goals_val.text(ActivePlayer.goals);
                active_shots_val.text(ActivePlayer.shots);
                active_score_val.text(ActivePlayer.score);
                active_assists_val.text(ActivePlayer.assists);
                active_saves_val.text(ActivePlayer.saves);
                active_boost_bar.css('width', `${ActivePlayer.boost}%`); 
                // active_boost_bar.css('filter', `hue-rotate(${275*(1 - (ActivePlayer.boost/100))}deg)`); 
                // active_boost_bar.text(`${ActivePlayer.speed}mph`); 
            }
            
            // function str_pad_left(string){
            //     let pad = '0';
            //     let length = 2;   
            //     return (new Array(length+1).join(pad)+string).slice(-length);   
            // }

            // function getTime(game) {
            //     var minutes = str_pad_left((Math.floor(game.time / 100)));
            //     // var seconds = str_pad_left((Math.round(game.time - minutes * 60)));
            //     var seconds = 0;
            //     return `${game.isOT ? '+' : ''}${minutes}:${seconds}`;
            // }

            // function getTime(game) {
            //     let time = (game.isOT ? '+' : '') 
            //     let showMs = game.time < 60 && !game.isOT;
            //     return time + (new Date(Math.ceil(game.time) * 1000)).toISOString().substr(showMs ? 17 : 15, 4);
            // }

            function getTime(game) {
                var m = Math.floor(game.time / 60);
                var s = ((Math.trunc(Math.ceil(game.time)) % 60)).toFixed(0);

                return `${(game.isOT ? '+' : "")} ${m}:${s < 10 ? '0' : ''}${s}`;
            }

            
                

       </script>
    </body>
</html>